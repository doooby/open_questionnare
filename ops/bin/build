#!/bin/bash
set -e

compose="docker-compose -f ops/docker-compose.yml"

echo "########### Building app image"
source ops/lib/build_app.sh ops
echo

echo "########### Building assets"
docker run --rm -v $(pwd)/../var/www:/var/www -v $(pwd)/../var/assets:/app/public/assets app:build bash -c "cp -R public/* /var/www && bin/rails assets:precompile assets:clean"
echo

echo "########### Building services images"
$compose build --pull
echo

echo "########### Migrate and deploy"
$compose run --rm app bin/rails db:migrate
$compose up -d
echo
